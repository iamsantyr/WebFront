<div class="consultar-container">
  <div class="consultar-card">
    <div class="consultar-header">
      <h2>Consultar Procesos</h2>

      <div class="search-bar">
        <input
          type="text"
          placeholder="Buscar por nombre o categoría..."
          [formControl]="searchForm.get('terminoBusqueda')"
          aria-label="Campo de búsqueda para filtrar procesos por nombre o categoría"
          (keydown.enter)="onKeyDown($event)"
        />
        <button 
          type="button"
          (click)="toggleFiltro()" 
          (keydown.enter)="toggleFiltro()"
          [attr.aria-expanded]="mostrarFiltro.toString()"
          [attr.aria-label]="mostrarFiltro ? 'Ocultar filtros' : 'Mostrar filtros'"
        >
          {{ mostrarFiltro ? 'Ocultar' : 'Filtros' }}
        </button>
      </div>
    </div>

    <!-- Panel de filtros -->
    <div *ngIf="mostrarFiltro" class="filter-panel" role="region" aria-label="Panel de filtros">
      <h3>Filtrar procesos</h3>
      
      <div class="filter-group">
        <label for="filtroFecha">Fecha de creación:</label>
        <input 
          id="filtroFecha"
          type="date" 
          [formControl]="searchForm.get('filtroFecha')"
          aria-describedby="filtroFecha-help"
        />
        <small id="filtroFecha-help" class="sr-only">Selecciona una fecha específica</small>
      </div>

      <div class="filter-group">
        <label for="filtroDuracion">Duración (días):</label>
        <input 
          id="filtroDuracion"
          type="number" 
          [formControl]="searchForm.get('filtroDuracion')"
          min="1"
          placeholder="Ej: 10"
          aria-describedby="filtroDuracion-help"
        />
        <small id="filtroDuracion-help" class="sr-only">Ingresa un número de días</small>
      </div>

      <div class="filter-group">
        <label for="filtroEstado">Estado:</label>
        <select 
          id="filtroEstado"
          [formControl]="searchForm.get('filtroEstado')"
          aria-describedby="filtroEstado-help"
        >
          <option value="">Todos los estados</option>
          <option value="activo">Activo</option>
          <option value="inactivo">Inactivo</option>
        </select>
        <small id="filtroEstado-help" class="sr-only">Selecciona el estado del proceso</small>
      </div>
    </div>

    <!-- Indicadores de estado -->
    <div class="loading-indicator" *ngIf="loading" role="status" aria-live="polite">
      <span>Cargando procesos...</span>
    </div>
    
    <div class="error-message" *ngIf="errorMessage" role="alert">
      <span>{{ errorMessage }}</span>
    </div>

    <!-- Lista de procesos -->
    <div class="procesos-lista" role="main">
      <div
        *ngFor="let proceso of filtrarProcesos(); trackBy: trackByProcesoId"
        class="proceso-item"
        role="article"
        [attr.aria-label]="'Proceso ' + proceso.nombre"
      >
        <div class="proceso-info">
          <span class="proceso-id">#{{ proceso.id }}</span>
          <div class="proceso-detalles">
            <span><strong>Nombre:</strong> {{ proceso.nombre }}</span>
            <span><strong>Categoría:</strong> {{ proceso.categoria }}</span>
            <span><strong>Estado:</strong> {{ proceso.estado }}</span>
          </div>
        </div>
        <button 
          class="ver-btn" 
          (click)="abrirModal(proceso)"
          (keydown.enter)="onKeyDown($event, proceso)"
          [attr.aria-label]="'Ver detalles del proceso ' + proceso.nombre"
        >
          Ver Detalles
        </button>
      </div>
      
      <!-- Mensaje cuando no hay procesos -->
      <div 
        *ngIf="!loading && filtrarProcesos().length === 0" 
        class="no-results"
        role="status"
        aria-live="polite"
      >
        <p>{{ 
          mostrarFiltro && (searchForm.value.terminoBusqueda || searchForm.value.filtroEstado || searchForm.value.filtroFecha || searchForm.value.filtroDuracion > 0)
            ? 'No se encontraron procesos que coincidan con los filtros aplicados'
            : 'No hay procesos disponibles'
        }}</p>
      </div>
    </div>
  </div>
</div>

<!-- Modal overlay -->
<div 
  class="modal-overlay" 
  *ngIf="modalOpen" 
  (click)="cerrarModal()"
  (keydown.escape)="onKeyDown($event)"
  tabindex="-1"
>
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Detalles del proceso "{{ procesoSeleccionado?.nombre }}"</h3>
      <button 
        class="close-btn" 
        aria-label="Cerrar" 
        (click)="cerrarModal()"
        (keydown.enter)="onKeyDown($event)"
      >✕</button>
    </div>

    <div class="modal-body">
      <p><strong>ID:</strong> {{ procesoSeleccionado?.id }}</p>
      <p><strong>Nombre:</strong> {{ procesoSeleccionado?.nombre }}</p>
      <p><strong>Descripción:</strong> {{ procesoSeleccionado?.descripcion }}</p>
      <p><strong>Categoría:</strong> {{ procesoSeleccionado?.categoria }}</p>
      <p><strong>Estado:</strong> {{ procesoSeleccionado?.estado }}</p>
      <p><strong>Fecha:</strong> {{ procesoSeleccionado?.fecha }}</p>
      <p><strong>Duración (días):</strong> {{ procesoSeleccionado?.duracion }}</p>

      <div class="detalles">
        <h4>Actividades</h4>
        <ul>
          <li *ngFor="let a of procesoSeleccionado?.actividadesProceso">{{ a }}</li>
        </ul>

        <h4>Arcos</h4>
        <ul>
          <li *ngFor="let arc of procesoSeleccionado?.arcosProceso">{{ arc }}</li>
        </ul>

        <h4>Gateways</h4>
        <ul>
          <li *ngFor="let g of procesoSeleccionado?.gatewaysProceso">{{ g }}</li>
        </ul>
      </div>
    </div>

    <div class="modal-footer">
      <button (click)="cerrarModal()">Cerrar</button>
    </div>
  </div>
</div>
